# encoding: utf-8
class JobController < ApplicationController
  before_action :authenticate_logging_in, only: [:edit, :update]
  before_action(:except => [:index, :new, :create]) { |c| c.prepare_request(params[:id]) }

  def index
    @job = Job.all
  end

  def show
    
  end

  def edit
  end

  def update
    @job.update_attributes(params[:job].permit!)
    redirect_to @job, notice: "Successfully updated your request"
  end

  def new
    @job = Job.new
  end

  def create
    @job = Job.new(params[:job].permit!)

    if current_user
      @job.employer = current_employer
    end
    if @request.save
      @job.update
      redirect_to @job
    else
      flash[:notice] = @job.errors.full_messages
      flash[:alert] = "الرجاء ادخال بيانات صحيحة"
      render 'new'

    end
  end

  def request
    @request = @job.request
  end

  def request

      @request = Request.new(job: @job, applicant: current_applicant)
      if @request.save
        redirect_to @job, notice: "لقد تم التقدم بنجاح"
      else
        redirect_to @job, alert: "هناك مشكلة ما"
      end

  end

  # private
    def authenticate_logging_in
      unless employer_signed_in? || current_employer
        redirect_to root_path, alert: "يجب عليك التسجيل أولاً!"
      end
    end

    def require_authority(args)
      unless (current_employer && (@job.employer == current_employer) )
        redirect_to root_path, alert: "لا تستطيع تعديل هذا الحساب."
      end
    end

    def prepare_request(args)
      @job = Job.find(args)
      unless @job
        redirect_to root_path, alert: "هناك مشكلة ما!"
      end
    end
end
